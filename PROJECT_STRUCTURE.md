# Context Cut Pro - プロジェクト構成図

```
context-cut-pro/
│
├── 📄 app.py                          # メインアプリケーション（Streamlit UI）
│   ├── 動画インジェスト機能
│   │   ├── Google Drive URL対応
│   │   ├── Web URL（YouTube等）対応
│   │   └── ローカルファイルアップロード
│   │
│   ├── AI文字起こし機能
│   │   ├── Whisper（baseモデル）
│   │   └── キャッシュ機能付き
│   │
│   ├── RAG検索システム
│   │   ├── ChromaDB ベクトルデータベース
│   │   └── 自然言語シーン検索
│   │
│   ├── カット範囲指定UI
│   │   ├── 数値入力（秒単位）
│   │   ├── スライダー調整
│   │   └── プレビュー生成（FFmpeg高速コピー）
│   │
│   ├── テロップ編集UI
│   │   ├── テキスト入力
│   │   ├── 動的フォント選択
│   │   ├── フォントアップロード機能
│   │   ├── スタイル設定（サイズ、色、背景）
│   │   └── 位置設定
│   │
│   └── 動画生成処理
│       ├── FFmpegトリミング
│       ├── テロップ合成（drawtext）
│       └── MP4エクスポート
│
├── 📄 requirements.txt                # Python依存ライブラリ
│   ├── streamlit                     # UIフレームワーク
│   ├── openai-whisper                # AI文字起こし
│   ├── chromadb                      # ベクトルDB
│   ├── langchain                     # RAGフレームワーク
│   ├── google-api-python-client      # Google Drive API
│   ├── yt-dlp                        # Web動画ダウンロード
│   ├── ffmpeg-python                 # 動画処理
│   ├── torch / torchaudio            # Whisper依存
│   └── その他ユーティリティ
│
├── 📄 packages.txt                    # システム依存パッケージ
│   └── ffmpeg                        # 動画処理エンジン
│
├── 📄 README.md                       # プロジェクト説明書
│   ├── 機能説明
│   ├── デプロイ手順
│   ├── GCP設定方法
│   ├── Secrets設定
│   ├── ローカル開発環境構築
│   ├── 使い方ガイド
│   └── トラブルシューティング
│
├── 📄 .gitignore                      # Git除外設定
│   ├── Python関連（__pycache__, venv等）
│   ├── 一時ファイル（temp_videos/, *.mp4等）
│   ├── ChromaDB データ
│   ├── Secrets
│   └── IDE/OS関連
│
├── 📂 fonts/                          # フォントディレクトリ（要リポジトリ含有）
│   ├── NotoSansJP-Regular.ttf        # デフォルト日本語フォント
│   └── [ユーザー追加フォント]        # アップロードまたは手動追加
│
├── 📂 temp_videos/                    # 一時動画保存（Git除外）
│   ├── video_*.mp4                   # ダウンロード動画
│   ├── preview.mp4                   # プレビュークリップ
│   └── final_output.mp4              # 最終生成動画
│
├── 📂 chromadb_data/                  # ChromaDBデータ（Git除外）
│   └── [自動生成ファイル]            # ベクトルインデックス
│
└── 📂 .streamlit/                     # Streamlit設定
    └── secrets.toml                  # 認証情報（Git除外）
        └── gcp_service_account       # Google Cloud認証キー

```

---

## 🔄 データフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                        ユーザー入力                              │
│  (Google Drive URL / Web URL / ローカルファイル)                  │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      動画ダウンロード                            │
│  ├─ Google Drive API (service account認証)                       │
│  ├─ yt-dlp (YouTube等)                                          │
│  └─ Streamlit file_uploader                                     │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Whisper AI 文字起こし                          │
│  ├─ 音声抽出                                                     │
│  ├─ 日本語認識（baseモデル）                                      │
│  └─ タイムスタンプ付きセグメント生成                              │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              ChromaDB インデックス化（RAG）                      │
│  ├─ テキストセグメント分割                                        │
│  ├─ ベクトル埋め込み                                             │
│  └─ メタデータ保存（start, end, segment_id）                     │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                  自然言語シーン検索                              │
│  ├─ ユーザークエリをベクトル化                                    │
│  ├─ コサイン類似度検索                                           │
│  └─ 関連シーン抽出（タイムスタンプ付き）                          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│               カット範囲指定（UI調整）                           │
│  ├─ 検索結果から初期範囲設定                                     │
│  ├─ スライダー/数値入力で微調整                                  │
│  └─ FFmpeg高速プレビュー生成（コピーモード）                      │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    テロップ編集                                  │
│  ├─ テキスト入力                                                 │
│  ├─ フォント選択（動的プルダウン）                                │
│  ├─ フォントアップロード（即反映）                                │
│  ├─ スタイル設定（サイズ、色、背景）                              │
│  └─ 位置設定                                                     │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              FFmpeg 最終動画生成                                 │
│  ├─ トリミング（指定範囲）                                        │
│  ├─ drawtext フィルタ適用                                        │
│  │   ├─ fontfile: 選択フォント                                  │
│  │   ├─ fontsize, fontcolor: UI設定値                           │
│  │   ├─ box, boxcolor: 背景設定                                 │
│  │   └─ x, y: 位置設定                                          │
│  └─ MP4出力（H.264 + AAC）                                       │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ユーザー出力                                  │
│  ├─ プレビュー表示（st.video）                                   │
│  └─ ダウンロードボタン（MP4ファイル）                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔐 認証フロー（Google Drive）

```
┌─────────────────────────────────────────────────────────────────┐
│              Streamlit Community Cloud Secrets                  │
│  .streamlit/secrets.toml → st.secrets["gcp_service_account"]   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│         Google Service Account Credentials                      │
│  ├─ type: "service_account"                                     │
│  ├─ project_id                                                  │
│  ├─ private_key                                                 │
│  ├─ client_email                                                │
│  └─ scopes: drive.readonly                                      │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│            Google Drive API v3 接続                             │
│  service = build('drive', 'v3', credentials=credentials)        │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                  ファイルダウンロード                            │
│  request = service.files().get_media(fileId=file_id)            │
│  MediaIoBaseDownload(fh, request)                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📦 デプロイメント構成（Streamlit Community Cloud）

```
┌─────────────────────────────────────────────────────────────────┐
│                    GitHub Repository                            │
│  https://github.com/yourusername/context-cut-pro               │
└─────────────────────┬───────────────────────────────────────────┘
                      │ (Auto Deploy)
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│          Streamlit Community Cloud Container                    │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  1. システム依存インストール（packages.txt）              │ │
│  │     apt-get install ffmpeg                                │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  2. Python依存インストール（requirements.txt）            │ │
│  │     pip install -r requirements.txt                       │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  3. フォントディレクトリ同期                              │ │
│  │     fonts/ → コンテナ内                                   │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  4. Secrets注入                                           │ │
│  │     Secrets → st.secrets（環境変数）                      │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  5. アプリ起動                                            │ │
│  │     streamlit run app.py                                  │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│               Public HTTPS URL                                  │
│  https://your-app-name.streamlit.app                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 主要コンポーネント

### 1. **app.py** (メインアプリケーション)
- **行数**: 約700行
- **主要クラス/関数**:
  - `get_available_fonts()`: フォント管理
  - `save_uploaded_font()`: フォントアップロード処理
  - `download_from_google_drive()`: Google Drive連携
  - `download_from_web()`: Web URL対応
  - `load_whisper_model()`: Whisperモデルロード（キャッシュ）
  - `transcribe_video()`: 文字起こし実行
  - `setup_chromadb()`: ChromaDB初期化
  - `index_transcription_to_chromadb()`: RAGインデックス化
  - `search_scenes()`: 自然言語検索
  - `create_preview_clip()`: プレビュー生成
  - `generate_final_video_with_subtitle()`: 最終動画生成
  - `main()`: Streamlit UI メインループ

### 2. **requirements.txt** (依存ライブラリ)
- **合計**: 15パッケージ
- **重要パッケージ**:
  - Streamlit: UIフレームワーク
  - Whisper: AI文字起こし
  - ChromaDB: ベクトルDB
  - FFmpeg-python: 動画処理バインディング
  - yt-dlp: 動画ダウンロード
  - google-api-python-client: Google Drive API

### 3. **packages.txt** (システム依存)
- **ffmpeg**: 動画処理の中核エンジン

### 4. **fonts/** (フォントディレクトリ)
- **デフォルト**: NotoSansJP-Regular.ttf（286KB）
- **拡張性**: ユーザーがアップロード可能（.ttf, .otf）

---

## 🚀 次のステップ

1. **GitHubリポジトリ作成**
   ```bash
   # GitHubで新しいリポジトリ作成後
   git remote add origin https://github.com/yourusername/context-cut-pro.git
   git push -u origin main
   ```

2. **Streamlit Community Cloudデプロイ**
   - [Streamlit Cloud](https://streamlit.io/cloud) にアクセス
   - リポジトリ接続
   - Secrets設定（GCP service account）

3. **動作確認**
   - デプロイ完了後、アプリにアクセス
   - テスト動画でフルフロー確認

4. **オプション機能追加（将来の拡張）**
   - 複数テロップ対応
   - アニメーション効果
   - バッチ処理
   - 動画品質設定
   - 多言語対応

---

**Context Cut Pro は、クラウドネイティブな設計により、Streamlit Community Cloud で即座にデプロイ可能です！🎬**
